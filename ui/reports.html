<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reports</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="stylesheet" href="styles/bootstrap.css"/>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>Production Support <small>Reports Page</small></h1>
    </div>
    <div class="row">
        <div class="col-xs-4">
            <h3></h3>
            <p>
            <form>
                <div class="form-group">
                    <label for="email">Email address:</label>
                    <input type="email" class="form-control" id="email">
                </div>
                <div class="form-group">
                    <label for="reportType">Report Type:</label>
                    <select class="form-control" id="reportType">
                        <option name="Weekly">weekly</option>
                        <option name="SLA">sla</option>
                    </select>
                </div>
            </form>
            <a href="#" class="btn btn-success" id="sendReportHref">Send Report</a>
            <a href="#" class="btn btn-primary" id="getReportHref">Get Report</a>
            </p>
        </div>
    </div>
    <hr>
</div>

<script src="scripts/rx.js"></script>
<script src="scripts/rx.dom.js"></script>
<script src="scripts/jquery.min.js"></script>
<!--<script src="scripts/app.js"></script>-->
<script>

    BugApp = {};

    BugApp.Params = {
        onlineUrl: 'ws://localhost:9000/api/online/sla',
        getReportUrl: 'http://localhost:9000/api/report/',
        sendReportUrl: 'http://localhost:9000/api/mail/',
        report: {
            sla: {
                weeks: 5
            },
            weekly: {
                weeks: 15
            }
        },
        selectedReport: function() {
            return $("#reportType option:selected").text();
        },
        paramString: function(reportType) {
            var params = BugApp.Params.report[reportType];
            var s = '/';
            for (var key in params) {
                s = s + key + '/' +  params[key] + '/';
            }
            return s.substring(0, s.length - 1);
        }
    };

    BugApp.reports = {
        getReport: function(reportType) {
            return $.ajax({
                url : BugApp.Params.getReportUrl + reportType + BugApp.Params.paramString(reportType),
                type: 'GET',
                crossDomain: true,
                dataType: 'text',
                success : function(resp, status, xhr) {
                    console.log();

                    var file = new Blob([resp], { type: xhr.getResponseHeader('Content-Type') });
                    var URL = window.URL || window.webkitURL;
                    var fileUrl = URL.createObjectURL(file);

                    var link = document.createElement('a');
                    document.body.appendChild(link);
                    link.href = fileUrl;
                    link.download = "report.pdf";
                    link.click();

                    setTimeout(function () { URL.revokeObjectURL(fileUrl); /*document.body.removeChild(link); */}, 100); // cleanup
                },
                error : function(xhr, status, err) {
                    console.error(err);
                }
            });
        },

        sendReport: function(reportType) {
            return $.ajax({
                url : BugApp.Params.sendReportUrl + reportType + BugApp.Params.paramString(reportType),
                type: 'POST',
                crossDomain: true,
                contentType: 'application/json',
                dataType: 'json',
                data: '{"to": ["a@a.aa"], "from": "noreply@b.bb", "cc" : []}',
                success : function(resp, status, xhr) {
                    console.log(resp);
                },
                error : function(xhr, status, err) {
                    console.error(err);
                }
            });
        }
    };

    $("#getReportHref").on('click', function() {
        BugApp.reports.getReport(BugApp.Params.selectedReport());
        return false;
    });

    $("#sendReportHref").on('click', function() {
        BugApp.reports.sendReport(BugApp.Params.selectedReport());
        return false;
    });
</script>

</body>
</html>